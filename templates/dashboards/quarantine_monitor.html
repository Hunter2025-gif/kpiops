{% extends "base.html" %}

{% block title %}Quarantine Monitor - Kampala Pharmaceuticals{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Back Button -->
        <div class="col-12 mb-4">
            <a href="/dashboard/admin-overview/" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Admin Dashboard
            </a>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2><i class="fas fa-shield-virus"></i> Quarantine Monitoring</h2>
                    <p>Monitor quarantine batches and sample processing timeline</p>
                </div>
                <div class="card-body">
                    <!-- Quarantine Stats -->
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stats-card bg-info text-white">
                                <div class="metric-value">{{ quarantine_stats.total_quarantine_batches|default:0 }}</div>
                                <div class="metric-label">Total Quarantine Batches</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stats-card bg-warning text-dark">
                                <div class="metric-value">{{ quarantine_stats.pending_qa_samples|default:0 }}</div>
                                <div class="metric-label">Pending QA Samples</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stats-card bg-secondary text-white">
                                <div class="metric-value">{{ quarantine_stats.pending_qc_samples|default:0 }}</div>
                                <div class="metric-label">Pending QC Samples</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="stats-card bg-success text-white">
                                <div class="metric-value">{{ quarantine_stats.approved_samples_today|default:0 }}</div>
                                <div class="metric-label">Approved Today</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Debug Info -->
                    <div class="alert alert-info">
                        <h5>Data Diagnostics</h5>
                        <div id="data-stats">
                            <p>Total quarantine batches: {{ quarantine_stats.total_quarantine_batches|default:"Not available" }}</p>
                            <p>Pending QA samples: {{ quarantine_stats.pending_qa_samples|default:"Not available" }}</p>
                            <p>Pending QC samples: {{ quarantine_stats.pending_qc_samples|default:"Not available" }}</p>
                            <p>Sample requests: {{ recent_sample_requests|length|default:"Not available" }}</p>
                        </div>
                    </div>
                    
                    <!-- Quarantine Batches Section -->
                    <div class="card mt-4">
                        <div class="card-header bg-light">
                            <h5><i class="fas fa-shield-virus"></i> Active Quarantine Batches</h5>
                        </div>
                        <div class="card-body">
                            {% if quarantine_batches %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>Batch Number</th>
                                                <th>Product</th>
                                                <th>Current Phase</th>
                                                <th>Status</th>
                                                <th>Quarantine Time</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for batch in quarantine_batches %}
                                            <tr>
                                                <td><strong>{{ batch.bmr.batch_number }}</strong></td>
                                                <td>{{ batch.bmr.product.product_name }}</td>
                                                <td>{{ batch.current_phase.phase_name }}</td>
                                                <td>
                                                    {% if batch.status == 'quarantined' %}
                                                        <span class="badge bg-warning">Quarantined</span>
                                                    {% elif batch.status == 'sample_requested' %}
                                                        <span class="badge bg-info">Sample Requested</span>
                                                    {% elif batch.status == 'sample_in_qa' %}
                                                        <span class="badge bg-primary">Sample with QA</span>
                                                    {% elif batch.status == 'sample_in_qc' %}
                                                        <span class="badge bg-secondary">Sample with QC</span>
                                                    {% elif batch.status == 'sample_approved' %}
                                                        <span class="badge bg-success">Sample Approved</span>
                                                    {% elif batch.status == 'sample_failed' %}
                                                        <span class="badge bg-danger">Sample Failed</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ batch.status }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ batch.quarantine_duration_hours }} hours</td>
                                                <td>
                                                    <a href="{% url 'quarantine:details' batch.id %}" class="btn btn-sm btn-info">
                                                        <i class="fas fa-search"></i> Details
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <h5 class="text-muted">No Active Quarantine Batches</h5>
                                    <p class="text-muted">There are no active quarantine batches in the system.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Recent Sample Requests with Detailed Timeline -->
                    <div class="card mt-4">
                        <div class="card-header bg-light">
                            <h5><i class="fas fa-list-alt"></i> Recent Sample Requests</h5>
                        </div>
                        <div class="card-body">
                            {% if recent_sample_requests %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>Batch Number</th>
                                                <th>Product</th>
                                                <th>Request Time</th>
                                                <th>QA Received</th>
                                                <th>QC Received</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for sample in recent_sample_requests %}
                                            <tr>
                                                <td>
                                                    <strong>{{ sample.quarantine_batch.bmr.batch_number }}</strong>
                                                </td>
                                                <td>{{ sample.quarantine_batch.bmr.product.product_name }}</td>
                                                <td>
                                                    <span class="text-muted">{{ sample.request_date|date:"M d, Y" }}</span><br>
                                                    <small class="text-info">{{ sample.request_date|time:"H:i" }}</small><br>
                                                    <small class="text-secondary">by {{ sample.requested_by.get_full_name }}</small>
                                                </td>
                                                <td>
                                                    {% if sample.sample_date %}
                                                        <span class="text-muted">{{ sample.sample_date|date:"M d, Y" }}</span><br>
                                                        <small class="text-info">{{ sample.sample_date|time:"H:i" }}</small>
                                                    {% else %}
                                                        <span class="text-warning">Pending</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if sample.received_date %}
                                                        <span class="text-muted">{{ sample.received_date|date:"M d, Y" }}</span><br>
                                                        <small class="text-info">{{ sample.received_date|time:"H:i" }}</small>
                                                    {% else %}
                                                        <span class="text-warning">Pending</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if sample.qc_status == 'approved' %}
                                                        <span class="badge bg-success">Approved</span>
                                                    {% elif sample.qc_status == 'failed' %}
                                                        <span class="badge bg-danger">Failed</span>
                                                    {% else %}
                                                        <span class="badge bg-warning">Pending</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{% url 'quarantine:details' sample.quarantine_batch.id %}" class="btn btn-sm btn-info">
                                                        <i class="fas fa-search"></i> Details
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-clipboard-check fa-3x text-success mb-3"></i>
                                    <h5 class="text-muted">No Sample Requests Found</h5>
                                    <p class="text-muted">There are no recent sample requests in the system.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}